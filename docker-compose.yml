services:
  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U \"$POSTGRES_USER\" -d \"$POSTGRES_DB\" -h localhost"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  api:
    image: ghcr.io/${GHCR_REPO:-semblable/lingua-read-api}:latest
    build: ./server/LinguaReadApi
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # For ASP.NET Core Connection String
      ConnectionStrings__DefaultConnection: Host=db;Port=5432;Database=${POSTGRES_DB};Username=${POSTGRES_USER};Password=${POSTGRES_PASSWORD}
      # For pg_dump/pg_restore in DatabaseAdminService
      PGHOST: db
      PGPORT: 5432
      PGDATABASE: ${POSTGRES_DB}
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
      # Other variables
      Jwt__Key: ${JWT_KEY}
      Jwt__Issuer: ${JWT_ISSUER}
      Jwt__Audience: ${JWT_AUDIENCE}
      DeepL__ApiKey: ${DEEPL_API_KEY}
      Gemini__ApiKey: ${GEMINI_API_KEY}
      Auth__LoginSecret: ${LOGIN_SECRET}
      Cors__AllowedOrigins: ${CORS_ALLOWED_ORIGINS}
    volumes:
      - api_audio_lessons:/app/wwwroot/audio_lessons
      - api_audiobooks:/app/wwwroot/audiobooks
    expose:
      - "5000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:5000/api/Health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  nginx:
    image: ghcr.io/${GHCR_REPO:-semblable/lingua-read-nginx}:latest
    build: ./client/lingua-read-client
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "80:80"
    volumes:
      # Provide Basic Auth credentials at runtime (do not bake into image).
      # Create this file on the host with: `htpasswd -c secrets/nginx.htpasswd <user>`
      - ./secrets/nginx.htpasswd:/etc/nginx/.htpasswd:ro

volumes:
  db_data:
  api_audio_lessons:
  api_audiobooks: